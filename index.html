<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>施設予約状況</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:12px;}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .btn{padding:6px 10px;border:1px solid #ccc;border-radius:10px;background:#fff;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .meta{opacity:.7;font-size:12px}
    .date{font-weight:700}
    .gridwrap{overflow:auto;border:1px solid #ddd;border-radius:12px}
    table{border-collapse:separate;border-spacing:0;min-width:900px;width:100%}
    th,td{border-bottom:1px solid #eee;border-right:1px solid #eee;padding:6px;font-size:12px;white-space:nowrap}
    th{position:sticky;top:0;background:#f7f7f7;z-index:2}
    th.room{left:0;z-index:3}
    td.room{position:sticky;left:0;background:#fff;z-index:1;font-weight:700}
    .slot{height:26px; position:relative}
    .block{
      position:absolute; top:3px; bottom:3px;
      border-radius:10px; background:#e9eefc; border:1px solid #c8d6ff;
      display:flex; align-items:center; padding:0 8px; overflow:hidden; text-overflow:ellipsis;
      font-size:12px;
    }
    .legend{margin-top:8px;font-size:12px;opacity:.75}
    input[type="text"]{padding:6px 10px;border:1px solid #ccc;border-radius:10px;width:120px}
  </style>
</head>
<body>
  <h2>施設予約状況</h2>

  <div class="bar">
    <button class="btn" id="prevDay">＜前日</button>
    <button class="btn" id="today">本日</button>
    <button class="btn" id="nextDay">翌日＞</button>
    <button class="btn" id="nextWeek">翌週＞＞</button>

    <span class="date" id="dispDate">-</span>

    <span style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <span>指定日(YYYYMMDD)</span>
      <input id="pick" type="text" placeholder="20260205" />
      <button class="btn" id="go">検索</button>
    </span>
  </div>

  <div class="meta" id="meta">読み込み中…</div>

  <div class="gridwrap" id="wrap"></div>
  <div class="legend">※ 予約クリックでの「予約操作」までは再現していません（表示専用）。</div>
<script>
const GAS_URL = "あなたの/exec URLをここ（今のやつでOK）";

let currentYmd = null;

// ---------- 日付ユーティリティ ----------
function ymdToDate(ymd){
  const y = parseInt(ymd.slice(0,4),10);
  const m = parseInt(ymd.slice(4,6),10)-1;
  const d = parseInt(ymd.slice(6,8),10);
  return new Date(y,m,d);
}
function dateToYmd(dt){
  const y = String(dt.getFullYear()).padStart(4,"0");
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const d = String(dt.getDate()).padStart(2,"0");
  return y+m+d;
}
function addDaysYmd(ymd, delta){
  const dt = ymdToDate(ymd);
  dt.setDate(dt.getDate()+delta);
  return dateToYmd(dt);
}
function weekdayJa(ymd){
  const w = ["日","月","火","水","木","金","土"];
  return w[ymdToDate(ymd).getDay()];
}
function ymdLabel(ymd){
  if(!ymd || ymd.length !== 8) return "-";
  return `${ymd.slice(0,4)}/${ymd.slice(4,6)}/${ymd.slice(6,8)}（${weekdayJa(ymd)}）`;
}

// ---------- 時間 ----------
function hhmm(s){
  if(!s || s.length !== 4) return s;
  return s.slice(0,2)+":"+s.slice(2);
}
function toMin(hhmmStr){
  const h = parseInt(hhmmStr.slice(0,2),10);
  const m = parseInt(hhmmStr.slice(2),10);
  return h*60+m;
}

// ---------- 通信 ----------
function fetchByDate(ymd){
  return new Promise((resolve) => {
    const cbName = "cb_" + Math.random().toString(36).slice(2);
    window[cbName] = (data) => {
      try { resolve(data); } finally {
        delete window[cbName];
        script.remove();
      }
    };

    const url = new URL(GAS_URL);
    url.searchParams.set("date", ymd);
    url.searchParams.set("callback", cbName);

    const script = document.createElement("script");
    script.src = url.toString();
    script.onerror = () => {
      resolve({ ok:false, error:"jsonp load failed" });
      delete window[cbName];
      script.remove();
    };
    document.body.appendChild(script);
  });
}


// ---------- 描画（刻み30分のまま） ----------
function buildGrid(data){
  const info = data.timetableInfo;
  const rooms = info.shisetsuInfo || [];
  const reserves = info.reserveInfo || {};
  const param = info.param || {};

  const beg = param.rsvBegTime || "0900";
  const end = param.rsvEndTime || "2100";
  const step = 30; // ←刻みは現状維持
  const begMin = toMin(beg);
  const endMin = toMin(end);

  const cols = [];
  for(let t=begMin; t<endMin; t+=step){
    const h = String(Math.floor(t/60)).padStart(2,"0");
    const m = String(t%60).padStart(2,"0");
    cols.push(h+m);
  }

  let html = `<div class="gridwrap"><table><thead><tr><th class="room">施設名称</th>`;
  for(const c of cols) html += `<th>${hhmm(c)}</th>`;
  html += `</tr></thead><tbody>`;

  for(const r of rooms){
    const roomcd = r.roomcd;
    const roomnm = r.roomnm;
    const list = reserves[roomcd] || [];

    html += `<tr><td class="room">${roomnm}<div style="opacity:.65;font-weight:400">${hhmm(r.frtm)}–${hhmm(r.totm)} / 定員 ${r.maxusrcnt}</div></td>`;

    for(let i=0;i<cols.length;i++){
      html += `<td><div class="slot" data-room="${roomcd}" data-idx="${i}"></div></td>`;
    }
    html += `</tr>`;

    // ブロック配置（開始セルに横長ブロックとして置く）
    setTimeout(() => {
      const rowSlots = Array.from(document.querySelectorAll(`.slot[data-room="${roomcd}"]`));
      for(const x of list){
        const st = toMin(x.intm);
        const ed = toMin(x.outtm);
        const stIdx = Math.max(0, Math.floor((st - begMin) / step));
        const edIdx = Math.min(cols.length, Math.ceil((ed - begMin) / step));
        if(!rowSlots[stIdx]) continue;

        const span = Math.max(1, edIdx - stIdx);
        const startEl = rowSlots[stIdx];

        const block = document.createElement("div");
        block.className = "block";
        block.textContent = `${hhmm(x.intm)}–${hhmm(x.outtm)}`;

        // span分の横幅を「右方向に伸ばす」簡易実装
        const cellW = startEl.closest("td").getBoundingClientRect().width;
        block.style.left = "2px";
        block.style.width = `${Math.max(1, span) * cellW - 6}px`;

        startEl.appendChild(block);
      }
    }, 0);
  }

  html += `</tbody></table></div>`;
  document.getElementById("wrap").innerHTML = html;
}

// ---------- ロード ----------
async function loadDate(ymd){
  const meta = document.getElementById("meta");
  meta.textContent = "読み込み中…";

  const data = await fetchByDate(ymd);
  if(!data.ok){
    meta.textContent = "取得失敗: " + (data.error || "unknown");
    return;
  }

  currentYmd = data.date || ymd;
  document.getElementById("dispDate").textContent = ymdLabel(currentYmd);

  meta.textContent = "更新: " + new Date(data.fetchedAt).toLocaleString("ja-JP");
  buildGrid(data);
}

// ---------- ボタン ----------
document.getElementById("today").onclick = () => {
  const now = new Date();
  const ymd = dateToYmd(now);
  loadDate(ymd);
};

document.getElementById("nextDay").onclick = () => {
  if(!currentYmd) return;
  loadDate(addDaysYmd(currentYmd, 1));
};

document.getElementById("prevDay").onclick = () => {
  if(!currentYmd) return;
  loadDate(addDaysYmd(currentYmd, -1));
};

document.getElementById("nextWeek").onclick = () => {
  if(!currentYmd) return;
  loadDate(addDaysYmd(currentYmd, 7));
};

document.getElementById("go").onclick = () => {
  const v = document.getElementById("pick").value.trim();
  if(!/^\d{8}$/.test(v)){
    alert("YYYYMMDD（例: 20260205）で入れてね");
    return;
  }
  loadDate(v);
};

// 初回表示＝本日
(() => {
  const now = new Date();
  loadDate(dateToYmd(now));
})();
</script>
</body>
</html>
